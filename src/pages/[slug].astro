---
import { SectionType } from "../interfaces/section.interface";
import Layout from "../layouts/Layout.astro";
import { getPageBySlug } from "../services/page.service";
import { getMainImage } from "../utils/get-main-image";

const page = await getPageBySlug(Astro.params.slug!);

if (page && Astro.params.slug !== page?.slug) {
  return Astro.redirect(`/${page.slug}`);
}

// Carga dinámica de todas las secciones disponibles en src/sections
const sectionModules = import.meta.glob("../sections/**/*.astro");

const getSectionComponent = async (type: string) => {
  // Creamos un mapa de tipos a archivos (puedes personalizarlo)
  const map: Record<string, string> = {
    [SectionType.CONTACT_TOP_BAR]: "../sections/ContactTopBar.astro",
    [SectionType.MAIN_NAVIGATION_MENU]:
      "../sections/MainNavigationMenu/MainNavigationMenu.astro",
    [SectionType.HERO]: "../sections/Hero.astro",
    [SectionType.WHY_US]: "../sections/WhyUs.astro",
    [SectionType.CASH_PROCESSING_EQUIPMENT]:
      "../sections/CashProcessingEquipment.astro",
    [SectionType.VALUE_PROPOSITION]: "../sections/ValueProposition.astro",
    [SectionType.SOLUTIONS_OVERVIEW]: "../sections/SolutionsOverview.astro",
    [SectionType.MISSION_VISION]: "../sections/MissionVision.astro",
    [SectionType.FULL_MAINTENANCE_PLAN]:
      "../sections/FullMaintenancePlan.astro",
    [SectionType.PREVENTIVE_CORRECTIVE_MAINTENANCE]:
      "../sections/PreventiveCorrectiveMaintenance.astro",
    [SectionType.MACHINE_DETAILS]: "../sections/MachineDetails.astro",
    [SectionType.MACHINES_CATALOG]: "../sections/MachinesCatalog.astro",
    [SectionType.SUPPORT_MAINTENANCE]: "../sections/SupportMaintenance.astro",
    [SectionType.OPERATIONAL_BENEFITS]: "../sections/OperationalBenefits.astro",
    [SectionType.SUPPORT_WIDGET]: "../sections/SupportWidget.astro",
    [SectionType.MACHINE]: "../sections/Machines.astro",
    [SectionType.CTA_BANNER]: "../sections/CTABanner.astro",
    [SectionType.OUR_COMPANY]: "../sections/OurCompany.astro",
    [SectionType.CLIENT]: "../sections/Clients.astro",
    [SectionType.CONTACT_US]: "../sections/ContactUs.astro",
    [SectionType.FOOTER]: "../sections/Footer.astro",
  };

  const path = map[type];
  if (!path || !sectionModules[path]) return null;

  const mod = await sectionModules[path]();
  return (mod as any).default;
};

const getMaintenanceComponent = async () => {
  const mod = await sectionModules["../sections/Maintenance.astro"]();
  return (mod as any).default;
};

const sectionMachineDetails = page?.sections?.find(
  (section) => section.type === SectionType.MACHINE_DETAILS
);

const machine = sectionMachineDetails?.machines?.[0];

const mainImage = machine && getMainImage(machine);
---

{
  page == null ? (
    <Layout title="Mantenimiento">
      {await getMaintenanceComponent().then((MaintenanceComponent) => (
        <MaintenanceComponent
          title="Por favor, ten paciencia con nosotros! Actualmente estamos en mantenimiento."
          description="Nos tomará un tiempo arreglar el error. Volveremos a estar en línea."
        />
      ))}
    </Layout>
  ) : (
    <Layout
      title={page.title}
      image={mainImage}
      description={page?.description}
      cardDescription={machine?.long_description}
    >
      {page.sections?.length
        ? await Promise.all(
            page.sections.map(async (section) => {
              const Section = await getSectionComponent(section.type);
              return Section ? <Section section={section} /> : null;
            })
          )
        : await getMaintenanceComponent().then((MaintenanceComponent) => (
            <MaintenanceComponent
              title="Estamos construyendo esta página. Vuelve pronto."
              description="Nos tomará un tiempo arreglar el error. Volveremos a estar en línea."
            />
          ))}
    </Layout>
  )
}
