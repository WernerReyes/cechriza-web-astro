---
import Icon from "@/components/ui/Icon.astro";
import Link from "@/components/ui/Link.astro";
import ToggleSwitch from "@/components/ui/ToggleSwitch.astro";
import { CategoryType } from "@/interfaces/category.entity";
import type { Section } from "@/interfaces/section.interface";
import SectionLayout from "@/layouts/SectionLayout.astro";
import { getMainImage } from "@/utils/get-main-image";

interface Props {
  section: Section;
}

const { section } = Astro.props as Props;

const switchId = "toggleCoinBill";
---

<SectionLayout class="bg-tg-bg">
  <header class="text-center mb-5 animate-fadeInUp">
    <h2 class="subtitle text-primary! text-lg!">{section.title}</h2>
  </header>

  <div class="text-center ml-auto w-fit mb-5 animate-fadeInUp">
    <ToggleSwitch
      id={switchId}
      checked={false}
      onLabel="Monedas"
      offLabel="Billetes"
    />
  </div>

  {
    section.machines && (
      <div
        class="slider-machines animate-fadeInUp"
        role="region"
        aria-label={`Carrusel de ${section.title}`}
      >
        <ul class="swiper-wrapper">
          {section.machines?.map((machine) => (
            <li class="swiper-slide" role="group" aria-roledescription="slide">
              <Link
                link={machine.link}
                aria-label={`Ver detalles de ${machine.name}`}
              >
                <article class="machine flex flex-col items-center text-center">
                  <figure>
                    <img
                      src={getMainImage(machine)}
                      alt={`Imagen de ${machine.name}`}
                      class="mx-auto"
                    />
                    <figcaption class="mt-2">
                      <h3 class="text-lg font-semibold">{machine.name}</h3>
                      <p class="text-sm text-gray-600">{machine.description}</p>
                    </figcaption>
                  </figure>

                  <footer class="tickets flex items-center me-auto gap-2 mt-3">
                    {machine.category && (
                      <>
                        <span class="ticket">{machine.category.title}</span>
                        <span class="ticket flex items-center gap-1">
                          {machine.category.type === CategoryType.BILL && (
                            <>
                              <Icon name="banknote" />
                              <span class="sr-only">Billetes</span>
                            </>
                          )}
                          {machine.category.type === CategoryType.COIN && (
                            <>
                              <Icon name="coins" />
                              <span class="sr-only">Monedas</span>
                            </>
                          )}
                        </span>
                      </>
                    )}
                  </footer>
                </article>
              </Link>
            </li>
          ))}
        </ul>
      </div>
    )
  }
</SectionLayout>

<script
  define:vars={{
    machines: section.machines,
    categoryType: CategoryType,
    switchId,
  }}
>
  const toggle = document.getElementById(switchId);
  const slider = document.querySelector(".slider-machines");
  const sliders = slider.querySelectorAll(".swiper-slide");
  const swipperWrapper = slider.querySelector(".swiper-wrapper");

  toggle.addEventListener("change", () => {
    const showCoins = toggle.checked;

    // Ocultamos todas con una animación de salida
    sliders.forEach((slide) => {
      slide.classList.add("animate-fadeOut");
      setTimeout(() => {
        const machineIndex = Array.from(sliders).indexOf(slide);
        const machine = machines[machineIndex];
        const isCoinMachine = machine.category?.type === categoryType.COIN;

        if (showCoins && isCoinMachine) {
          slide.style.display = "block";
        } else if (!showCoins && !isCoinMachine) {
          slide.style.display = "block";
        } else {
          slide.style.display = "none";
        }

        // Volvemos a mostrar con fade in si corresponde
        slide.classList.remove("animate-fadeOut");
        slide.classList.add("animate-fadeIn");
      }, 150);
    });

    // Verificamos si todas están ocultas
    setTimeout(() => {
      const hiddenSlides = Array.from(sliders).filter(
        (slide) => slide.style.display === "none"
      ).length;

      let emptyMessage = slider.querySelector(".empty-message");

      if (hiddenSlides === sliders.length) {
        if (!emptyMessage) {
          swipperWrapper.insertAdjacentHTML(
            "afterend",
            `<div class="empty-message animate-fadeIn">
              <div class="p-8 bg-gray-50 border border-dashed border-gray-300 rounded-2xl text-center shadow-inner">
                <div class="text-6xl mb-3 text-gray-300">
                  <img src="/machine.webp" alt="Ícono de máquinas no disponibles" class="w-16 h-16 mx-auto" />
                </div>
                <p class="text-gray-600 text-lg font-medium mb-1">No hay máquinas disponibles</p>
                <p class="text-gray-400 text-sm">Prueba cambiando la categoría para ver más opciones.</p>
              </div>
            </div>`
          );
        }
      } else if (emptyMessage) {
        emptyMessage.classList.add("animate-fadeOut");
        setTimeout(() => emptyMessage.remove(), 300);
      }
    }, 200);
  });
</script>


<script>
  import Swiper from "swiper/bundle";
  import "swiper/css/bundle";

  new Swiper(".slider-machines", {
    slidesPerView: 3,
    spaceBetween: 30,
    centerInsufficientSlides: true,
    loop: true,
    autoplay: {
      delay: 2500,
      disableOnInteraction: false,
    },
    breakpoints: {
      0: {
        slidesPerView: 1,
        spaceBetween: 20,
      },
      768: {
        slidesPerView: 2,
        spaceBetween: 40,
      },
      1024: {
        slidesPerView: 3,
        spaceBetween: 50,
      },
    },
  });
</script>
<style>
  .machine {
    flex: 1 1 50%;
    background-color: #f0f0f0;
    padding: 40px 30px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    text-align: left;
    box-sizing: border-box;
    transition: all 0.4s ease; /* transición suave */
    position: relative;
    overflow: hidden;
  }

  .machine img {
    width: 200px;
    height: 200px;
    margin: 0 auto 20px;
    display: block;
    object-fit: cover;
    transition:
      transform 0.4s ease,
      box-shadow 0.4s ease; /* animación en imagen */
    filter: drop-shadow(0 0 0 rgba(0, 0, 0, 0)); /* sin sombra inicial */
  }
  /* width: 100%;
    height: 100%;
    object-fit: contain; */
  .machine h3 {
    font-size: 1.8rem;
    margin: 10px 0;
    color: #222;
    transition: color 0.4s ease;
  }

  .machine p {
    color: #444;
    margin-bottom: 20px;
    transition: color 0.4s ease;
  }

  .tickets {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .ticket {
    border: 1px solid #ccc;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    background-color: #fff;
    transition: all 0.4s ease;
  }

  /* --- Efectos al hacer hover --- */
  .machine:hover {
    background-color: #4b7cc7ff;
    color: #fff;
    transform: translateY(-6px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
  }

  .machine:hover h3 {
    color: #fff;
  }

  .machine:hover p {
    color: #e0e0e0;
  }

  .machine:hover .ticket {
    background-color: transparent;
    border: 1px solid #fff;
    color: #fff;
  }

  .machine:hover img {
    transform: scale(1.05);
    filter: drop-shadow(0 0 25px black); /* halo azul acoplado */
  }

  @media (max-width: 768px) {
    .machine {
      flex: 1 1 100%;
    }
  }

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: 0.4s;
    transition: 0.4s;
    border-radius: 34px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: 0.4s;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #043399;
  }

  input:focus + .slider {
    box-shadow: 0 0 1px #043399;
  }

  input:checked + .slider:before {
    -webkit-transform: translateX(26px);
    -ms-transform: translateX(26px);
    transform: translateX(26px);
  }
</style>
